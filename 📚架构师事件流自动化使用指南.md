# 📚 架构师事件流自动化使用指南

## 🎯 两种自动化机制

### 1️⃣ 对话记录自动保存（API方式）

**功能**：通过API接口保存对话记录到`architect-conversations.json`

**API端点**：
```
POST http://localhost:8800/api/architect/save-conversation
```

**使用方法**：

#### 方式A：在对话中告诉AI保存
```
用户：保存这个对话记录，标题是"XXX功能开发讨论"
```

AI会调用API保存对话。

#### 方式B：使用curl命令保存
```bash
curl -X POST http://localhost:8800/api/architect/save-conversation \
  -H "Content-Type: application/json" \
  -d '{
    "title": "对话标题",
    "total_tokens": 50000,
    "messages_count": 25,
    "summary": "对话摘要",
    "tags": ["标签1", "标签2"]
  }'
```

#### 方式C：在Dashboard前端添加"保存"按钮（待实现）

**保存的数据格式**：
```json
{
  "session_id": "conv-011",        // 自动生成
  "title": "对话标题",
  "project_id": "TASKFLOW",
  "model": "claude-3-5-sonnet-4",
  "status": "completed",           // active/completed
  "total_tokens": 50000,
  "messages_count": 25,
  "created_at": "2025-11-21 18:00:00",
  "updated_at": "2025-11-21 18:30:00",
  "participants": ["用户", "AI架构师"],
  "summary": "对话摘要",
  "tags": ["tag1", "tag2"]
}
```

---

### 2️⃣ 事件流自动监听（文件监听）

**功能**：监听项目文件变化，自动添加事件到`architect_events.json`

**监听脚本**：`scripts/auto_monitor_architect_events.py`

**启动方式**：
```bash
# 方式1：使用启动脚本
./启动事件监听器.sh

# 方式2：直接运行Python脚本
python3 scripts/auto_monitor_architect_events.py
```

**监听的目录**：
- `docs/reports/` - 完成报告、审查报告
- `docs/arch/` - 架构文档
- 项目根目录 - 部署脚本

**自动识别的事件类型**：

| 文件特征 | 事件类型 | 图标 | 示例 |
|---------|---------|-----|-----|
| 文件名包含"完成报告" | task_complete | ✅ | REQ-001完成报告.md |
| 文件名包含"审查报告" | code_review | 🔍 | 架构师审查-REQ-002.md |
| 文件名包含"交接" | handoff | 🤝 | 交接-透视塔部署.md |
| 文件名包含"启动"/"部署"/"*.bat"/"*.sh" | deployment | 🚀 | 启动8820-Dashboard.bat |
| 文件名包含"测试"/"验证" | test | 🧪 | Dashboard功能测试.md |

**工作原理**：
1. 监听器持续监控指定目录
2. 检测到文件创建或修改
3. 判断文件类型（完成报告/部署/测试等）
4. 自动添加事件到JSON文件
5. Dashboard自动刷新显示新事件

**防重复机制**：
- 冷却时间：5秒
- 同一个文件5秒内只触发一次事件

---

## 🚀 快速开始

### Step 1: 安装依赖
```bash
pip3 install watchdog
```

### Step 2: 启动监听器（后台运行）
```bash
cd "/Users/yalinwang/Desktop/任务所 1.8/taskflow-v1-2/taskflow-v1-2"
./启动事件监听器.sh &
```

### Step 3: 测试监听器
创建一个测试文件：
```bash
echo "测试" > docs/reports/测试完成报告.md
```

应该会看到：
```
✅ 事件已记录: 任务完成报告: 测试完成报告.md
```

### Step 4: 查看Dashboard
刷新浏览器，「事件流」Tab应该显示新事件。

---

## 💡 使用建议

### 场景1：李明完成任务
```bash
# 李明提交完成报告
docs/reports/REQ-005-Dashboard重构-完成报告.md
↓
监听器自动记录事件
↓
Dashboard自动显示"任务完成报告: REQ-005-Dashboard重构-完成报告.md"
```

### 场景2：架构师审查代码
```bash
# 架构师生成审查报告
docs/reports/架构师审查-REQ-005-完成报告.md
↓
监听器自动记录事件
↓
Dashboard显示"代码审查完成: 架构师审查-REQ-005-完成报告.md"
```

### 场景3：部署到生产环境
```bash
# 创建部署脚本
启动8820-新功能.bat
↓
监听器自动记录事件
↓
Dashboard显示"部署脚本更新: 启动8820-新功能.bat"
```

---

## 🔧 高级配置

### 自定义监听目录
编辑 `scripts/auto_monitor_architect_events.py`：
```python
WATCH_DIRS = [
    PROJECT_ROOT / "docs" / "reports",
    PROJECT_ROOT / "你的目录",
]
```

### 自定义文件模式
```python
REPORT_PATTERNS = ["完成报告", "你的关键词"]
```

### 调整冷却时间
```python
self.cooldown = 10  # 改为10秒
```

---

## 📊 效果预览

**自动监听效果**：
```
用户创建文件 → 监听器检测 → 自动添加事件 → Dashboard实时显示
```

**手动保存对话**：
```
对话结束 → 告诉AI保存 → 调用API → 对话历史Tab显示
```

---

## ⚠️ 注意事项

1. **监听器需要保持运行**
   - 后台运行：`./启动事件监听器.sh &`
   - 查看进程：`ps aux | grep auto_monitor`
   - 停止监听：`pkill -f auto_monitor_architect_events.py`

2. **API服务必须启动**
   - 保存对话需要API服务（8800端口）

3. **冷却时间**
   - 同一文件5秒内只触发一次
   - 避免编辑文件时重复触发

4. **文件命名规范**
   - 完成报告建议命名：`REQ-XXX-功能名-完成报告.md`
   - 审查报告建议命名：`架构师审查-REQ-XXX-完成报告.md`
   - 部署脚本建议命名：`启动XXXX-服务名.bat`

---

## 🧪 测试API

### 测试保存对话
```bash
curl -X POST http://localhost:8800/api/architect/save-conversation \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试对话",
    "total_tokens": 5000,
    "messages_count": 10,
    "summary": "这是一个测试对话",
    "tags": ["test"]
  }'
```

成功返回：
```json
{
  "success": true,
  "message": "对话记录已保存",
  "session_id": "conv-011"
}
```

---

**现在你有两套自动化机制了！** 🎉

