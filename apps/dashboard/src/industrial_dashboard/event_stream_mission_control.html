<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>äº‹ä»¶æµ - æ—¶é—´ä¹‹æ²³ - ä»»åŠ¡æ‰€Â·Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* é¢œè‰²ç³»ç»Ÿ */
            --black: #000000;
            --gray-900: #212121;
            --gray-700: #616161;
            --gray-600: #757575;
            --gray-500: #9E9E9E;
            --gray-300: #E0E0E0;
            --gray-100: #F5F5F5;
            --gray-50: #FAFAFA;
            --white: #FFFFFF;
            --red: #985239;
            --blue: #537696;
            
            --info: #2E7D32;
            --warning: #F57C00;
            --error: #D32F2F;
            --critical: #C62828;
            
            /* ç©ºé—´ */
            --space-2: 8px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
            
            /* é˜´å½± */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--white);
            color: var(--gray-900);
            line-height: 1.6;
        }
        
        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-300);
            padding: var(--space-4) var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .back-button {
            text-decoration: none;
            color: var(--gray-700);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .back-button:hover {
            color: var(--black);
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--black);
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-4);
        }
        
        .action-btn {
            padding: var(--space-2) var(--space-4);
            font-size: 13px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }
        
        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: var(--gray-50);
            border-right: 1px solid var(--gray-300);
            padding: var(--space-6);
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin-bottom: var(--space-8);
        }
        
        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-box {
            background: var(--white);
            border: 1px solid var(--gray-300);
            padding: var(--space-4);
            margin-bottom: var(--space-2);
        }
        
        .stat-box-value {
            font-size: 32px;
            font-weight: 300;
            color: var(--black);
            line-height: 1;
        }
        
        .stat-box-label {
            font-size: 11px;
            color: var(--gray-600);
            margin-top: 4px;
        }
        
        .filter-group {
            margin-bottom: var(--space-4);
        }
        
        .filter-label {
            font-size: 11px;
            color: var(--gray-600);
            margin-bottom: var(--space-2);
            display: block;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 13px;
            cursor: pointer;
        }
        
        .checkbox-item input {
            cursor: pointer;
        }
        
        .filter-buttons {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }
        
        .filter-btn {
            flex: 1;
            padding: var(--space-2);
            font-size: 12px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
        }
        
        .filter-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: var(--space-8);
        }
        
        /* ä»Šæ—¥æ¦‚è§ˆ */
        .today-overview {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            border: 1px solid var(--gray-300);
            border-top: 2px solid var(--red);
            padding: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        .overview-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
        }
        
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .mini-stat {
            text-align: center;
        }
        
        .mini-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--black);
        }
        
        .mini-stat-label {
            font-size: 10px;
            color: var(--gray-600);
        }
        
        /* äº‹ä»¶æ—¶é—´æµ */
        .events-stream {
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-top: 2px solid var(--black);
            padding: var(--space-8);
        }
        
        .stream-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .event-card {
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-left: 4px solid var(--info);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            cursor: pointer;
        }
        
        .event-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }
        
        .event-card.warning {
            border-left-color: var(--warning);
        }
        
        .event-card.error {
            border-left-color: var(--error);
        }
        
        .event-card.critical {
            border-left-color: var(--critical);
        }
        
        .event-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        .severity-badge {
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
            text-transform: uppercase;
        }
        
        .severity-badge.info {
            background: var(--info);
            color: var(--white);
        }
        
        .severity-badge.warning {
            background: var(--warning);
            color: var(--white);
        }
        
        .severity-badge.error {
            background: var(--error);
            color: var(--white);
        }
        
        .severity-badge.critical {
            background: var(--critical);
            color: var(--white);
        }
        
        .event-type-label {
            font-size: 11px;
            color: var(--gray-600);
        }
        
        .event-time-label {
            font-size: 11px;
            color: var(--gray-500);
            margin-left: auto;
        }
        
        .event-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--black);
            margin-bottom: var(--space-2);
        }
        
        .event-description {
            font-size: 13px;
            color: var(--gray-700);
            margin-bottom: var(--space-4);
        }
        
        .event-footer {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: 11px;
            color: var(--gray-600);
        }
        
        .event-tag {
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: 2px;
            font-size: 10px;
        }
        
        .event-actions {
            margin-top: var(--space-4);
            display: flex;
            gap: var(--space-2);
        }
        
        .event-action-btn {
            padding: 4px 12px;
            font-size: 11px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-action-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        /* åˆ†é¡µ */
        .pagination {
            margin-top: var(--space-6);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-4);
        }
        
        .page-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
        }
        
        .page-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .page-info {
            font-size: 13px;
            color: var(--gray-600);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-container {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-600);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--gray-300);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <div class="header">
        <a href="/" class="back-button">â† è¿”å›Dashboard</a>
        <div class="page-title">ğŸ“Š äº‹ä»¶æµ - æ—¶é—´ä¹‹æ²³</div>
        <div class="header-actions">
            <button class="action-btn">å¯¼å‡º</button>
            <button class="action-btn" onclick="loadEvents()">åˆ·æ–°</button>
        </div>
    </div>
    
    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <!-- äº‹ä»¶è„‰æ -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“ˆ äº‹ä»¶è„‰æ</div>
                <div class="stat-box">
                    <div class="stat-box-value" id="totalEventsCount">156</div>
                    <div class="stat-box-label">æ€»äº‹ä»¶</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="taskEventsCount">89</div>
                    <div class="stat-box-label">ä»»åŠ¡</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="issueEventsCount">34</div>
                    <div class="stat-box-label">é—®é¢˜</div>
                </div>
            </div>
            
            <!-- æ™ºèƒ½ç­›é€‰ -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ” æ™ºèƒ½ç­›é€‰</div>
                
                <div class="filter-group">
                    <div class="filter-label">åˆ†ç±»</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="category" value="task" checked> ğŸ“‹ ä»»åŠ¡
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="category" value="issue" checked> ğŸ› é—®é¢˜
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="category" value="decision"> ğŸ›ï¸ å†³ç­–
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="category" value="deployment" checked> ğŸš€ éƒ¨ç½²
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="category" value="system"> âš™ï¸ ç³»ç»Ÿ
                        </label>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label">ä¸¥é‡æ€§</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="severity" value="info" checked> ğŸŸ¢ Info
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="severity" value="warning" checked> ğŸŸ¡ Warning
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="severity" value="error" checked> ğŸŸ  Error
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="severity" value="critical" checked> ğŸ”´ Critical
                        </label>
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button class="filter-btn" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                    <button class="filter-btn" onclick="resetFilters()">é‡ç½®</button>
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- ä»Šæ—¥æ¦‚è§ˆ -->
            <div class="today-overview">
                <div class="overview-title">ğŸ¯ ä»Šæ—¥æ¦‚è§ˆ</div>
                <div class="mini-stats">
                    <div class="mini-stat">
                        <div class="mini-stat-value" id="todayEventsCount">12</div>
                        <div class="mini-stat-label">äº‹ä»¶</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value" id="todayWarningsCount">3</div>
                        <div class="mini-stat-label">è­¦å‘Š</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value" id="todayErrorsCount">1</div>
                        <div class="mini-stat-label">é”™è¯¯</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-value" id="todayCriticalCount">0</div>
                        <div class="mini-stat-label">ç´§æ€¥</div>
                    </div>
                </div>
            </div>
            
            <!-- äº‹ä»¶æ—¶é—´æµ -->
            <div class="events-stream">
                <div class="stream-title">
                    <span>ğŸŒŠ</span>
                    <span>äº‹ä»¶æ—¶é—´æµ</span>
                    <span style="margin-left: auto; font-size: 11px; color: var(--gray-500);">æœ€è¿‘100æ¡äº‹ä»¶</span>
                </div>
                
                <div id="eventsContainer">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: var(--space-4);">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div class="pagination">
                    <button class="page-btn" onclick="prevPage()">â† ä¸Šä¸€é¡µ</button>
                    <div class="page-info">ç¬¬<span id="currentPage">1</span>é¡µ/å…±<span id="totalPages">10</span>é¡µ</div>
                    <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â†’</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 50;
        let allEvents = [];
        let filters = {
            categories: ['task', 'issue', 'deployment'],
            severities: ['info', 'warning', 'error', 'critical']
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒŠ äº‹ä»¶æµé¡µé¢å·²åŠ è½½');
            loadEvents();
            
            // è‡ªåŠ¨åˆ·æ–°
            setInterval(loadEvents, 30000);
        });
        
        // åŠ è½½äº‹ä»¶
        async function loadEvents() {
            try {
                const response = await fetch('/api/events/stream?hours=24&limit=100');
                const data = await response.json();
                
                if (data.success && data.events) {
                    allEvents = data.events;
                    renderEvents();
                    updateStats();
                    console.log('âœ… äº‹ä»¶å·²åŠ è½½:', data.events.length);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½äº‹ä»¶å¤±è´¥:', error);
                document.getElementById('eventsContainer').innerHTML = `
                    <div class="loading-container">
                        <div style="color: var(--error);">åŠ è½½å¤±è´¥: ${error.message}</div>
                        <button class="action-btn" onclick="loadEvents()" style="margin-top: var(--space-4);">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“äº‹ä»¶
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            
            // è¿‡æ»¤äº‹ä»¶
            let filteredEvents = allEvents.filter(event => {
                const category = event.event_category || event.category || 'general';
                const severity = event.severity || 'info';
                return filters.categories.includes(category) && filters.severities.includes(severity);
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="loading-container">
                        <div style="font-size: 48px;">ğŸŒŠ</div>
                        <div style="margin-top: var(--space-4);">æš‚æ— äº‹ä»¶</div>
                    </div>
                `;
                return;
            }
            
            // åˆ†é¡µ
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageEvents = filteredEvents.slice(start, end);
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const totalPages = Math.ceil(filteredEvents.length / pageSize);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            // æ¸²æŸ“
            container.innerHTML = pageEvents.map(event => {
                const severity = event.severity || 'info';
                const category = event.event_category || event.category || 'general';
                const title = event.title || 'æ— æ ‡é¢˜';
                const description = event.description || '';
                const actor = event.actor || 'System';
                const time = formatTime(event.occurred_at || event.timestamp);
                const eventType = event.event_type || event.type || 'æœªçŸ¥äº‹ä»¶';
                
                return `
                    <div class="event-card ${severity}" onclick="viewEventDetail('${event.id}')">
                        <div class="event-card-header">
                            <span class="severity-badge ${severity}">${getSeverityIcon(severity)} ${severity.toUpperCase()}</span>
                            <span class="event-type-label">${eventType}</span>
                            <span class="event-time-label">${time}</span>
                        </div>
                        <div class="event-title">${title}</div>
                        ${description ? `<div class="event-description">${description}</div>` : ''}
                        <div class="event-footer">
                            <span>ğŸ‘¤ ${actor}</span>
                            <span>|</span>
                            <span>ğŸ“‹ ${category}</span>
                            ${event.related_entity_id ? `<span>| ğŸ”— ${event.related_entity_id}</span>` : ''}
                        </div>
                        ${event.tags ? `
                            <div style="margin-top: var(--space-2); display: flex; gap: var(--space-2);">
                                ${event.tags.map(tag => `<span class="event-tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="event-actions">
                            <button class="event-action-btn" onclick="event.stopPropagation(); viewEventDetail('${event.id}')">è¯¦æƒ…</button>
                            ${event.related_entity_id ? `<button class="event-action-btn" onclick="event.stopPropagation(); viewRelated('${event.related_entity_type}', '${event.related_entity_id}')">æŸ¥çœ‹å…³è”</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            // ç»Ÿè®¡ä»Šæ—¥äº‹ä»¶
            const today = new Date().toISOString().split('T')[0];
            const todayEvents = allEvents.filter(e => {
                const eventDate = (e.occurred_at || e.timestamp || '').split('T')[0];
                return eventDate === today;
            });
            
            document.getElementById('todayEventsCount').textContent = todayEvents.length;
            document.getElementById('todayWarningsCount').textContent = 
                todayEvents.filter(e => e.severity === 'warning').length;
            document.getElementById('todayErrorsCount').textContent = 
                todayEvents.filter(e => e.severity === 'error').length;
            document.getElementById('todayCriticalCount').textContent = 
                todayEvents.filter(e => e.severity === 'critical').length;
            
            // æ›´æ–°æ€»è®¡
            document.getElementById('totalEventsCount').textContent = allEvents.length;
            document.getElementById('taskEventsCount').textContent = 
                allEvents.filter(e => (e.event_category || e.category) === 'task').length;
            document.getElementById('issueEventsCount').textContent = 
                allEvents.filter(e => (e.event_category || e.category) === 'issue').length;
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            // è·å–é€‰ä¸­çš„åˆ†ç±»
            filters.categories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                .map(cb => cb.value);
            
            // è·å–é€‰ä¸­çš„ä¸¥é‡æ€§
            filters.severities = Array.from(document.querySelectorAll('input[name="severity"]:checked'))
                .map(cb => cb.value);
            
            currentPage = 1;
            renderEvents();
            console.log('å·²åº”ç”¨ç­›é€‰:', filters);
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            filters.categories = ['task', 'issue', 'decision', 'deployment', 'system'];
            filters.severities = ['info', 'warning', 'error', 'critical'];
            currentPage = 1;
            renderEvents();
            console.log('å·²é‡ç½®ç­›é€‰');
        }
        
        // åˆ†é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderEvents();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(allEvents.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderEvents();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // æŸ¥çœ‹äº‹ä»¶è¯¦æƒ…
        function viewEventDetail(eventId) {
            console.log('æŸ¥çœ‹äº‹ä»¶è¯¦æƒ…:', eventId);
            alert('äº‹ä»¶è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // æŸ¥çœ‹å…³è”å®ä½“
        function viewRelated(type, id) {
            console.log('æŸ¥çœ‹å…³è”:', type, id);
            alert(`æŸ¥çœ‹${type}: ${id}`);
        }
        
        // å·¥å…·å‡½æ•°
        function formatTime(timestamp) {
            if (!timestamp) return 'åˆšåˆš';
            
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffMins < 1440) return `${Math.floor(diffMins/60)}å°æ—¶å‰`;
            return time.toLocaleString('zh-CN');
        }
        
        function getSeverityIcon(severity) {
            const icons = {
                'info': 'ğŸŸ¢',
                'warning': 'ğŸŸ¡',
                'error': 'ğŸŸ ',
                'critical': 'ğŸ”´'
            };
            return icons[severity] || 'âšª';
        }
    </script>
</body>
</html>

