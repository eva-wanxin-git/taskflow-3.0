<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®çŸ¥è¯†åº“ - ä»»åŠ¡æ‰€Â·Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', 'SF Mono', monospace;
            background: #FFFDF7;
            color: #212121;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  - åœ¨iframeå†…éšè— */
        .top-nav {
            height: 60px;
            background: white;
            border-bottom: 2px solid #000;
            display: none;  /* éšè—é¡¶éƒ¨å¯¼èˆª */
            align-items: center;
            padding: 0 24px;
            gap: 16px;
        }
        
        .nav-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }
        
        .nav-link {
            padding: 8px 16px;
            background: white;
            border: 1px solid #000;
            color: #000;
            text-decoration: none;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            background: #000;
            color: white;
        }
        
        /* ä¸»å®¹å™¨ï¼šå·¦å³åˆ†æ  */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        /* å·¦ä¾§ï¼šæ–‡ä»¶æ ‘ */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #E0E0E0;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #E0E0E0;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E0E0E0;
            background: white;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #757575;
            background: white;
        }
        
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }
        
        /* æ–‡ä»¶æ ‘èŠ‚ç‚¹ */
        .tree-node {
            user-select: none;
        }
        
        .tree-node-header {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tree-node-header:hover {
            background: #f5f5f5;
        }
        
        .tree-node-header.active {
            background: #000;
            color: white;
        }
        
        .tree-node-header.active .tree-icon,
        .tree-node-header.active .tree-label {
            color: white;
        }
        
        .tree-toggle {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #616161;
            margin-right: 6px;
        }
        
        .tree-toggle.empty {
            opacity: 0;
        }
        
        .tree-icon {
            font-size: 14px;
            margin-right: 8px;
            color: #616161;
        }
        
        .tree-label {
            font-size: 12px;
            color: #212121;
            flex: 1;
        }
        
        .tree-count {
            font-size: 9px;
            color: #9e9e9e;
            margin-left: 8px;
        }
        
        .tree-children {
            display: none;
            padding-left: 20px;
        }
        
        .tree-node.expanded > .tree-children {
            display: block;
        }
        
        .tree-node.expanded > .tree-node-header > .tree-toggle::before {
            content: 'â–¼';
        }
        
        .tree-toggle::before {
            content: 'â–¶';
        }
        
        /* æ–‡ä»¶ç±»å‹å›¾æ ‡ */
        .icon-folder { color: #d4a373; }
        .icon-doc { color: #537696; }
        .icon-ux { color: #9c27b0; }
        .icon-ui { color: #e91e63; }
        .icon-md { color: #616161; }
        .icon-yaml { color: #985239; }
        
        /* å³ä¾§ï¼šå†…å®¹åŒº */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        
        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #E0E0E0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .breadcrumb-item {
            color: #616161;
        }
        
        .breadcrumb-item.active {
            color: #000;
            font-weight: 600;
        }
        
        .breadcrumb-separator {
            color: #bdbdbd;
        }
        
        /* å†…å®¹æ˜¾ç¤ºåŒº */
        .content-display {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }
        
        .doc-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E0E0E0;
        }
        
        .doc-title {
            font-size: 20px;
            font-weight: 700;
            color: #000;
            margin-bottom: 8px;
        }
        
        .doc-meta {
            display: flex;
            gap: 16px;
            font-size: 10px;
            color: #757575;
        }
        
        .doc-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .doc-content {
            background: white;
            padding: 24px;
            border: 1px solid #E0E0E0;
            min-height: 400px;
        }
        
        .doc-content h1 {
            font-size: 18px;
            margin-top: 24px;
            margin-bottom: 12px;
            color: #000;
            border-bottom: 1px solid #E0E0E0;
            padding-bottom: 8px;
        }
        
        .doc-content h2 {
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 12px;
            color: #212121;
            border-left: 3px solid #000;
            padding-left: 12px;
        }
        
        .doc-content h3 {
            font-size: 14px;
            margin-top: 16px;
            margin-bottom: 10px;
            color: #424242;
        }
        
        .doc-content p {
            line-height: 1.7;
            margin-bottom: 14px;
            color: #424242;
            font-size: 13px;
        }
        
        .doc-content ul, .doc-content ol {
            margin-bottom: 16px;
            padding-left: 24px;
        }
        
        .doc-content li {
            line-height: 1.7;
            margin-bottom: 6px;
            color: #424242;
            font-size: 13px;
        }
        
        .doc-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border: 1px solid #E0E0E0;
            font-size: 12px;
            color: #d32f2f;
        }
        
        .doc-content pre {
            background: #f5f5f5;
            border-left: 3px solid #000;
            padding: 14px;
            overflow-x: auto;
            margin-bottom: 14px;
        }
        
        .doc-content pre code {
            background: none;
            border: none;
            color: #212121;
            padding: 0;
            font-size: 12px;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9e9e9e;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 14px;
        }
        
        /* æ–‡æ¡£æ“ä½œæŒ‰é’® */
        .doc-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .action-btn {
            padding: 10px 20px;
            background: white;
            color: #000;
            border: 1px solid #000;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #f5f5f5;
        }
        
        .action-btn.secondary {
            background: white;
            color: #000;
            border: 1px solid #000;
        }
        
        .action-btn.secondary:hover {
            background: #f5f5f5;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 14px;
            color: #9e9e9e;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #bdbdbd;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9e9e9e;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 260px;
            }
            
            .content-display {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="nav-title">â—‰ é¡¹ç›®çŸ¥è¯†åº“ Â· Knowledge Base</div>
        <div class="nav-links">
            <a href="/" class="nav-link">â† Dashboard</a>
            <a href="/events" class="nav-link">äº‹ä»¶æµ</a>
            <a href="/memories" class="nav-link">è®°å¿†ç©ºé—´</a>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§ï¼šæ–‡ä»¶æ ‘ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <input 
                    type="text" 
                    class="search-box" 
                    id="searchBox"
                    placeholder="ğŸ” æœç´¢æ–‡æ¡£..."
                    onkeyup="searchDocs()"
                />
            </div>
            
            <div class="file-tree" id="fileTree">
                <div class="loading">åŠ è½½æ–‡ä»¶æ ‘...</div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå†…å®¹åŒº -->
        <div class="content-area">
            <!-- é¢åŒ…å±‘ -->
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">çŸ¥è¯†åº“</span>
            </div>
            
            <!-- å†…å®¹æ˜¾ç¤º -->
            <div class="content-display" id="contentDisplay">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <div class="empty-text">è¯·ä»å·¦ä¾§é€‰æ‹©æ–‡æ¡£æŸ¥çœ‹</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // çŸ¥è¯†åº“æ•°æ®ç»“æ„ï¼ˆå‚è€ƒDifyè®¾è®¡ï¼‰
        const knowledgeBase = {
            name: 'TASKFLOWçŸ¥è¯†åº“',
            children: [
                {
                    type: 'folder',
                    name: 'docs',
                    label: 'ğŸ“‹ é¡¹ç›®æ–‡æ¡£',
                    children: [
                        {
                            type: 'folder',
                            name: 'ai',
                            label: 'AIæç¤ºè¯',
                            children: [
                                { type: 'file', name: 'architect-system-prompt-expert.md', label: 'æ¶æ„å¸ˆæç¤ºè¯', category: 'ai' },
                                { type: 'file', name: 'fullstack-engineer-system-prompt.md', label: 'å…¨æ ˆå·¥ç¨‹å¸ˆæç¤ºè¯', category: 'ai' },
                                { type: 'file', name: 'AI-TEAM-GUIDE.md', label: 'AIå›¢é˜Ÿåä½œæŒ‡å—', category: 'ai' }
                            ]
                        },
                        {
                            type: 'folder',
                            name: 'arch',
                            label: 'æ¶æ„æ–‡æ¡£',
                            children: [
                                { type: 'file', name: 'architecture-review.md', label: 'æ¶æ„å®¡æŸ¥æŠ¥å‘Š', category: 'arch' },
                                { type: 'file', name: 'architecture-inventory.md', label: 'æ¶æ„ç›˜ç‚¹', category: 'arch' },
                                { type: 'file', name: 'refactor-plan.md', label: 'é‡æ„è®¡åˆ’', category: 'arch' }
                            ]
                        },
                        {
                            type: 'folder',
                            name: 'features',
                            label: 'åŠŸèƒ½æ–‡æ¡£',
                            children: [
                                { type: 'file', name: 'PROJECT_MEMORY_SPACE.md', label: 'é¡¹ç›®è®°å¿†ç©ºé—´', category: 'features' },
                                { type: 'file', name: 'event-system-quick-guide.md', label: 'äº‹ä»¶ç³»ç»Ÿå¿«é€ŸæŒ‡å—', category: 'features' }
                            ]
                        }
                    ]
                },
                {
                    type: 'folder',
                    name: 'knowledge',
                    label: 'ğŸ”§ çŸ¥è¯†åº“',
                    children: [
                        {
                            type: 'folder',
                            name: 'ux',
                            label: 'UXè®¾è®¡æ–‡æ¡£',
                            icon: 'ğŸ¨',
                            children: [
                                { type: 'file', name: 'ux-principles.md', label: 'UXè®¾è®¡åŸåˆ™', category: 'ux' },
                                { type: 'file', name: 'user-research.md', label: 'ç”¨æˆ·ç ”ç©¶', category: 'ux' },
                                { type: 'file', name: 'interaction-design.md', label: 'äº¤äº’è®¾è®¡', category: 'ux' },
                                { type: 'file', name: 'wireframes.md', label: 'çº¿æ¡†å›¾', category: 'ux' }
                            ]
                        },
                        {
                            type: 'folder',
                            name: 'ui',
                            label: 'UIè®¾è®¡æ–‡æ¡£',
                            icon: 'ğŸ­',
                            children: [
                                { type: 'file', name: 'ui-standards.md', label: 'UIè®¾è®¡è§„èŒƒ', category: 'ui' },
                                { type: 'file', name: 'color-system.md', label: 'è‰²å½©ç³»ç»Ÿ', category: 'ui' },
                                { type: 'file', name: 'typography.md', label: 'å­—ä½“ç³»ç»Ÿ', category: 'ui' },
                                { type: 'file', name: 'components.md', label: 'ç»„ä»¶åº“', category: 'ui' }
                            ]
                        },
                        {
                            type: 'folder',
                            name: 'issues',
                            label: 'é—®é¢˜è®°å½•',
                            children: [
                                { type: 'file', name: 'template.yaml', label: 'é—®é¢˜æ¨¡æ¿', category: 'issues' }
                            ]
                        },
                        {
                            type: 'folder',
                            name: 'solutions',
                            label: 'è§£å†³æ–¹æ¡ˆ',
                            children: [
                                { type: 'file', name: 'template.md', label: 'æ–¹æ¡ˆæ¨¡æ¿', category: 'solutions' }
                            ]
                        }
                    ]
                },
                {
                    type: 'folder',
                    name: 'database',
                    label: 'ğŸ—„ï¸ æ•°æ®åº“',
                    children: [
                        {
                            type: 'folder',
                            name: 'schemas',
                            label: 'Schemaæ–‡æ¡£',
                            children: [
                                { type: 'file', name: 'v1_tasks_schema.sql', label: 'ä»»åŠ¡è¡¨ç»“æ„', category: 'database' },
                                { type: 'file', name: 'v2_knowledge_schema.sql', label: 'çŸ¥è¯†åº“è¡¨ç»“æ„', category: 'database' },
                                { type: 'file', name: 'v3_events_schema.sql', label: 'äº‹ä»¶è¡¨ç»“æ„', category: 'database' }
                            ]
                        }
                    ]
                }
            ]
        };
        
        let currentPath = [];
        let currentDoc = null;
        
        // åˆå§‹åŒ–
        function init() {
            console.log('[çŸ¥è¯†åº“] åˆå§‹åŒ–ä¸­...');
            renderFileTree(knowledgeBase, document.getElementById('fileTree'));
            console.log('[çŸ¥è¯†åº“] åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ¸²æŸ“æ–‡ä»¶æ ‘ï¼ˆé€’å½’ï¼‰
        function renderFileTree(node, container, level = 0) {
            if (!node.children) return;
            
            container.innerHTML = '';
            
            node.children.forEach(item => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                
                if (item.type === 'folder') {
                    // æ–‡ä»¶å¤¹
                    const header = document.createElement('div');
                    header.className = 'tree-node-header';
                    header.onclick = (e) => {
                        e.stopPropagation();
                        toggleFolder(nodeDiv);
                    };
                    
                    const icon = item.icon || 'ğŸ“';
                    const count = countFiles(item);
                    
                    header.innerHTML = `
                        <span class="tree-toggle"></span>
                        <span class="tree-icon">${icon}</span>
                        <span class="tree-label">${item.label || item.name}</span>
                        <span class="tree-count">${count}</span>
                    `;
                    
                    nodeDiv.appendChild(header);
                    
                    // å­èŠ‚ç‚¹å®¹å™¨
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    renderFileTree(item, childrenDiv, level + 1);
                    nodeDiv.appendChild(childrenDiv);
                    
                } else {
                    // æ–‡ä»¶
                    const header = document.createElement('div');
                    header.className = 'tree-node-header';
                    header.onclick = () => loadDocument(item);
                    
                    const icon = getFileIcon(item);
                    
                    header.innerHTML = `
                        <span class="tree-toggle empty"></span>
                        <span class="tree-icon ${icon.class}">${icon.icon}</span>
                        <span class="tree-label">${item.label || item.name}</span>
                    `;
                    
                    nodeDiv.appendChild(header);
                }
                
                container.appendChild(nodeDiv);
            });
        }
        
        // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æ”¶èµ·
        function toggleFolder(nodeDiv) {
            nodeDiv.classList.toggle('expanded');
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(file) {
            const category = file.category || '';
            const name = file.name || '';
            
            if (category === 'ux' || name.includes('ux')) {
                return { icon: 'ğŸ¨', class: 'icon-ux' };
            }
            if (category === 'ui' || name.includes('ui')) {
                return { icon: 'ğŸ­', class: 'icon-ui' };
            }
            if (name.endsWith('.md')) {
                return { icon: 'ğŸ“„', class: 'icon-md' };
            }
            if (name.endsWith('.yaml') || name.endsWith('.yml')) {
                return { icon: 'âš™ï¸', class: 'icon-yaml' };
            }
            if (name.endsWith('.sql')) {
                return { icon: 'ğŸ—„ï¸', class: 'icon-doc' };
            }
            return { icon: 'ğŸ“„', class: 'icon-doc' };
        }
        
        // ç»Ÿè®¡æ–‡ä»¶æ•°
        function countFiles(node) {
            if (!node.children) return 0;
            
            let count = 0;
            node.children.forEach(child => {
                if (child.type === 'file') {
                    count++;
                } else if (child.type === 'folder') {
                    count += countFiles(child);
                }
            });
            return count;
        }
        
        // åŠ è½½æ–‡æ¡£å†…å®¹
        async function loadDocument(file) {
            console.log('[çŸ¥è¯†åº“] åŠ è½½æ–‡æ¡£:', file.name);
            
            // é«˜äº®å½“å‰é€‰ä¸­
            document.querySelectorAll('.tree-node-header').forEach(h => {
                h.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb(file);
            
            // åŠ è½½å†…å®¹
            try {
                const response = await fetch(`/api/knowledge/docs/${file.category}/${file.name}`);
                
                if (response.ok) {
                    const data = await response.json();
                    renderDocument(data);
                } else {
                    renderEmptyDoc(file);
                }
            } catch (error) {
                console.error('[çŸ¥è¯†åº“] åŠ è½½å¤±è´¥:', error);
                renderEmptyDoc(file);
            }
        }
        
        // æ¸²æŸ“æ–‡æ¡£
        function renderDocument(data) {
            const display = document.getElementById('contentDisplay');
            
            const html = `
                <div class="doc-header">
                    <div class="doc-title">${escapeHtml(data.title)}</div>
                    <div class="doc-meta">
                        <div class="doc-meta-item">
                            <span>ğŸ“</span>
                            <span>${escapeHtml(data.category || '-')}</span>
                        </div>
                        <div class="doc-meta-item">
                            <span>ğŸ“</span>
                            <span>${data.size || '-'}</span>
                        </div>
                        <div class="doc-meta-item">
                            <span>ğŸ•</span>
                            <span>${formatTime(data.updated_at)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="doc-content">
                    ${formatMarkdown(data.content || '')}
                </div>
                
                <div class="doc-actions">
                    <button class="action-btn" onclick="copyDocContent()">
                        å¤åˆ¶å†…å®¹
                    </button>
                    <button class="action-btn secondary" onclick="downloadDoc()">
                        ä¸‹è½½æ–‡æ¡£
                    </button>
                </div>
            `;
            
            display.innerHTML = html;
            currentDoc = data;
        }
        
        // æ¸²æŸ“ç©ºæ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰
        function renderEmptyDoc(file) {
            const display = document.getElementById('contentDisplay');
            
            const html = `
                <div class="doc-header">
                    <div class="doc-title">${escapeHtml(file.label || file.name)}</div>
                    <div class="doc-meta">
                        <div class="doc-meta-item">
                            <span>ğŸ“</span>
                            <span>${escapeHtml(file.category || '-')}</span>
                        </div>
                        <div class="doc-meta-item">
                            <span>ğŸ“</span>
                            <span>å¾…åˆ›å»º</span>
                        </div>
                    </div>
                </div>
                
                <div class="doc-content">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">æ­¤æ–‡æ¡£å°šæœªåˆ›å»º</div>
                        <div style="margin-top: 16px; font-size: 12px; color: #9e9e9e;">
                            æ‚¨å¯ä»¥é€šè¿‡æ¶æ„å¸ˆAIæˆ–æ‰‹åŠ¨åˆ›å»ºæ­¤æ–‡æ¡£
                        </div>
                    </div>
                </div>
                
                <div class="doc-actions">
                    <button class="action-btn" onclick="createNewDoc('${file.name}', '${file.category}')">
                        åˆ›å»ºæ–‡æ¡£
                    </button>
                </div>
            `;
            
            display.innerHTML = html;
            currentDoc = null;
        }
        
        // æ›´æ–°é¢åŒ…å±‘
        function updateBreadcrumb(file) {
            const breadcrumb = document.getElementById('breadcrumb');
            
            const parts = [
                '<span class="breadcrumb-item">çŸ¥è¯†åº“</span>',
                '<span class="breadcrumb-separator">/</span>',
                `<span class="breadcrumb-item">${file.category || 'docs'}</span>`,
                '<span class="breadcrumb-separator">/</span>',
                `<span class="breadcrumb-item active">${escapeHtml(file.label || file.name)}</span>`
            ];
            
            breadcrumb.innerHTML = parts.join('');
        }
        
        // ç®€å•çš„Markdownæ¸²æŸ“ï¼ˆåŸºæœ¬åŠŸèƒ½ï¼‰
        function formatMarkdown(text) {
            if (!text) return '';
            
            // è½¬ä¹‰HTML
            let html = escapeHtml(text);
            
            // ä»£ç å—
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // è¡Œå†…ä»£ç 
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // æ ‡é¢˜
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // åˆ—è¡¨
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // æ®µè½
            html = html.replace(/([^\n]+)\n\n/g, '<p>$1</p>');
            
            return html;
        }
        
        // æœç´¢æ–‡æ¡£
        function searchDocs() {
            const keyword = document.getElementById('searchBox').value.toLowerCase();
            
            if (!keyword) {
                // æ¸…ç©ºæœç´¢ï¼Œæ¢å¤å®Œæ•´æ ‘
                renderFileTree(knowledgeBase, document.getElementById('fileTree'));
                return;
            }
            
            // æœç´¢å¹¶é«˜äº®åŒ¹é…é¡¹
            const results = searchInTree(knowledgeBase, keyword);
            renderSearchResults(results);
        }
        
        // åœ¨æ ‘ä¸­æœç´¢
        function searchInTree(node, keyword, results = []) {
            if (!node.children) return results;
            
            node.children.forEach(child => {
                if (child.type === 'file') {
                    const label = (child.label || child.name).toLowerCase();
                    if (label.includes(keyword)) {
                        results.push(child);
                    }
                } else if (child.type === 'folder') {
                    searchInTree(child, keyword, results);
                }
            });
            
            return results;
        }
        
        // æ¸²æŸ“æœç´¢ç»“æœ
        function renderSearchResults(results) {
            const container = document.getElementById('fileTree');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-text">æœªæ‰¾åˆ°åŒ¹é…æ–‡æ¡£</div></div>';
                return;
            }
            
            results.forEach(file => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                
                const header = document.createElement('div');
                header.className = 'tree-node-header';
                header.onclick = () => loadDocument(file);
                
                const icon = getFileIcon(file);
                
                header.innerHTML = `
                    <span class="tree-toggle empty"></span>
                    <span class="tree-icon ${icon.class}">${icon.icon}</span>
                    <span class="tree-label">${file.label || file.name}</span>
                `;
                
                nodeDiv.appendChild(header);
                container.appendChild(nodeDiv);
            });
        }
        
        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
        
        function copyDocContent() {
            if (!currentDoc) return;
            
            navigator.clipboard.writeText(currentDoc.content).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥');
            });
        }
        
        function downloadDoc() {
            if (!currentDoc) return;
            
            const blob = new Blob([currentDoc.content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentDoc.filename || 'document.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function createNewDoc(filename, category) {
            alert(`åˆ›å»ºæ–‡æ¡£åŠŸèƒ½å¼€å‘ä¸­...\næ–‡ä»¶å: ${filename}\nåˆ†ç±»: ${category}`);
            // TODO: å®ç°åˆ›å»ºæ–‡æ¡£APIè°ƒç”¨
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

