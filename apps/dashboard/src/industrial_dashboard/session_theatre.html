<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè¯è¯¦æƒ… - å¯¹è¯å‰§åœº - ä»»åŠ¡æ‰€Â·Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --black: #000000;
            --gray-900: #212121;
            --gray-700: #616161;
            --gray-600: #757575;
            --gray-500: #9E9E9E;
            --gray-300: #E0E0E0;
            --gray-100: #F5F5F5;
            --white: #FFFFFF;
            --red: #985239;
            --blue: #537696;
            
            --status-active: #4CAF50;
            --status-completed: #9E9E9E;
            
            --space-2: 8px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å…¨å±å®¹å™¨ */
        .theatre-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* å…³é—­æŒ‰é’® */
        .close-bar {
            background: var(--black);
            padding: var(--space-4) var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-btn {
            color: var(--white);
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .session-badge {
            color: var(--white);
            font-size: 12px;
            padding: 4px 12px;
            background: var(--status-completed);
            border-radius: 2px;
        }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .info-bar {
            background: var(--white);
            border-bottom: 1px solid var(--gray-300);
            padding: var(--space-6) var(--space-8);
        }
        
        .session-title-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .session-meta {
            display: flex;
            gap: var(--space-6);
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: var(--space-4);
        }
        
        .session-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .tag {
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: 2px;
            font-size: 10px;
        }
        
        .session-actions {
            display: flex;
            gap: var(--space-4);
        }
        
        .action-btn {
            padding: var(--space-2) var(--space-4);
            font-size: 12px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
        }
        
        .action-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .action-btn-primary {
            background: var(--red);
            color: var(--white);
            border-color: var(--red);
        }
        
        .action-btn-primary:hover {
            background: var(--black);
        }
        
        /* æ¶ˆæ¯æµ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-8);
            background: var(--gray-100);
        }
        
        .message-bubble {
            max-width: 70%;
            margin-bottom: var(--space-6);
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-bubble.user {
            margin-left: auto;
        }
        
        .message-bubble.ai {
            margin-right: auto;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-size: 11px;
            color: var(--gray-600);
        }
        
        .message-sender {
            font-weight: 600;
        }
        
        .message-content {
            background: var(--white);
            border: 1px solid var(--gray-300);
            padding: var(--space-4);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .message-bubble.user .message-content {
            background: var(--blue);
            color: var(--white);
            border-color: var(--blue);
        }
        
        .message-bubble.ai .message-content {
            background: var(--white);
        }
        
        .code-block {
            background: var(--gray-900);
            color: var(--white);
            padding: var(--space-4);
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: var(--space-4) 0;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: var(--gray-100);
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>
<body>
    <div class="theatre-container">
        <!-- å…³é—­æ  -->
        <div class="close-bar">
            <button class="close-btn" onclick="closeTheatre()">âœ• å…³é—­</button>
            <div class="session-badge" id="sessionStatusBadge">å·²å®Œæˆ</div>
        </div>
        
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="info-bar">
            <div class="session-title-large">
                <span>ğŸ’¬</span>
                <span id="sessionTitle">Dashboardé‡æ„è®¨è®º</span>
            </div>
            <div class="session-meta">
                <span id="sessionTime">ğŸ“… 2025-11-18 22:30 - 23:45</span>
                <span>|</span>
                <span id="sessionParticipants">ğŸ‘¥ ç”¨æˆ· + æ¶æ„å¸ˆAI</span>
                <span>|</span>
                <span id="sessionDuration">â±ï¸ 1h 15min</span>
            </div>
            <div class="session-meta">
                <span id="sessionMessages">ğŸ’¬ 6æ¡æ¶ˆæ¯</span>
                <span>|</span>
                <span id="sessionTokens">ğŸ”¢ 25,000 tokens</span>
                <span>|</span>
                <span id="sessionAvgTokens">ğŸ“Š å¹³å‡4,167 tokens/æ¶ˆæ¯</span>
            </div>
            <div class="session-tags-row" id="sessionTags">
                <span>ğŸ·ï¸</span>
                <span class="tag">Dashboard</span>
                <span class="tag">é‡æ„</span>
                <span class="tag">UI</span>
            </div>
            <div class="session-actions">
                <button class="action-btn action-btn-primary" onclick="continueConversation()">ç»§ç»­å¯¹è¯</button>
                <button class="action-btn" onclick="exportConversation()">å¯¼å‡ºä¼šè¯</button>
                <button class="action-btn" onclick="editInfo()">ç¼–è¾‘ä¿¡æ¯</button>
                <button class="action-btn" onclick="deleteConversation()">åˆ é™¤</button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æµ -->
        <div class="messages-container" id="messagesContainer">
            <div style="text-align: center; padding: var(--space-8); color: var(--gray-500);">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
    
    <script>
        // è·å–URLå‚æ•°ä¸­çš„session_id
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id') || 'session-001';
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ­ å¯¹è¯å‰§åœºå·²åŠ è½½, Session:', sessionId);
            loadSessionDetail();
        });
        
        // åŠ è½½ä¼šè¯è¯¦æƒ…
        async function loadSessionDetail() {
            try {
                const response = await fetch(`/api/conversations/${sessionId}`);
                const session = await response.json();
                
                if (session && !session.error) {
                    renderSessionDetail(session);
                    console.log('âœ… ä¼šè¯è¯¦æƒ…å·²åŠ è½½');
                } else {
                    // ä½¿ç”¨ç¤ºä¾‹æ•°æ®
                    const demoSession = {
                        session_id: sessionId,
                        title: 'Dashboardé‡æ„è®¨è®º',
                        status: 'completed',
                        created_at: '2025-11-18 22:30:00',
                        updated_at: '2025-11-18 23:45:00',
                        messages_count: 6,
                        total_tokens: 25000,
                        participants: ['ç”¨æˆ·', 'æ¶æ„å¸ˆAI'],
                        tags: ['Dashboard', 'é‡æ„', 'UI'],
                        messages: [
                            {
                                id: 'msg-001',
                                timestamp: '2025-11-18 22:30:15',
                                from: 'ç”¨æˆ·',
                                content: 'è¯·åˆ†æå½“å‰Dashboardçš„æ¶æ„é—®é¢˜',
                                type: 'request',
                                tokens: 50
                            },
                            {
                                id: 'msg-002',
                                timestamp: '2025-11-18 22:32:40',
                                from: 'æ¶æ„å¸ˆAI',
                                content: 'æˆ‘åˆ†æäº†Dashboardçš„ä»£ç ï¼ˆ1622è¡Œï¼‰ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š\\n\\n**æ¶æ„å±‚é¢**ï¼š\\n1. æ¨¡å—è€¦åˆåº¦é«˜ - æ‰€æœ‰åŠŸèƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶\\n2. ç¼ºå°‘ç»Ÿä¸€çŠ¶æ€ç®¡ç†\\n3. Tabåˆ‡æ¢é€»è¾‘åˆ†æ•£åœ¨å¤šå¤„\\n\\n**æ€§èƒ½å±‚é¢**ï¼š\\n1. æ— ç¼“å­˜ç­–ç•¥ï¼Œæ¯æ¬¡åˆ·æ–°é‡æ–°åŠ è½½\\n2. æ•°æ®æ¥å£æœªä¼˜åŒ–',
                                type: 'response',
                                tokens: 8500
                            },
                            {
                                id: 'msg-003',
                                timestamp: '2025-11-18 22:35:20',
                                from: 'ç”¨æˆ·',
                                content: 'è¯·ç»™å‡ºå…·ä½“çš„é‡æ„å»ºè®®',
                                type: 'request',
                                tokens: 30
                            }
                        ]
                    };
                    renderSessionDetail(demoSession);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ä¼šè¯å¤±è´¥:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div style="text-align: center; padding: var(--space-8); color: var(--error);">
                        åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“ä¼šè¯è¯¦æƒ…
        function renderSessionDetail(session) {
            // æ›´æ–°æ ‡é¢˜æ 
            document.getElementById('sessionTitle').textContent = session.title;
            document.getElementById('sessionStatusBadge').textContent = getStatusText(session.status);
            document.getElementById('sessionStatusBadge').style.background = 
                session.status === 'active' ? 'var(--status-active)' : 'var(--status-completed)';
            
            // æ›´æ–°å…ƒä¿¡æ¯
            const duration = calculateDuration(session.created_at, session.updated_at);
            document.getElementById('sessionTime').textContent = 
                `ğŸ“… ${session.created_at} - ${session.updated_at.split(' ')[1]}`;
            document.getElementById('sessionParticipants').textContent = 
                `ğŸ‘¥ ${session.participants.join(' + ')}`;
            document.getElementById('sessionDuration').textContent = 
                `â±ï¸ ${duration}`;
            document.getElementById('sessionMessages').textContent = 
                `ğŸ’¬ ${session.messages_count}æ¡æ¶ˆæ¯`;
            document.getElementById('sessionTokens').textContent = 
                `ğŸ”¢ ${formatNumber(session.total_tokens)} tokens`;
            
            const avgTokens = Math.round(session.total_tokens / session.messages_count);
            document.getElementById('sessionAvgTokens').textContent = 
                `ğŸ“Š å¹³å‡${formatNumber(avgTokens)} tokens/æ¶ˆæ¯`;
            
            // æ›´æ–°æ ‡ç­¾
            const tagsContainer = document.getElementById('sessionTags');
            tagsContainer.innerHTML = `
                <span>ğŸ·ï¸</span>
                ${session.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            `;
            
            // æ¸²æŸ“æ¶ˆæ¯
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = session.messages.map(msg => {
                const isUser = msg.from === 'ç”¨æˆ·';
                const className = isUser ? 'user' : 'ai';
                const icon = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
                
                return `
                    <div class="message-bubble ${className}">
                        <div class="message-header">
                            <span>${icon}</span>
                            <span class="message-sender">${msg.from}</span>
                            <span>|</span>
                            <span>${msg.timestamp.split(' ')[1]}</span>
                            <span>|</span>
                            <span>ğŸ”¢ ${formatNumber(msg.tokens)} tokens</span>
                        </div>
                        <div class="message-content">
                            ${formatMessageContent(msg.content)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            // ç®€å•çš„Markdownæ¸²æŸ“
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code style="background: var(--gray-100); padding: 2px 4px; border-radius: 2px;">$1</code>')
                .replace(/```([\\s\\S]*?)```/g, '<div class="code-block">$1</div>')
                .replace(/\\n/g, '<br>');
        }
        
        // è®¡ç®—æ—¶é•¿
        function calculateDuration(start, end) {
            const startTime = new Date(start);
            const endTime = new Date(end);
            const diffMs = endTime - startTime;
            const hours = Math.floor(diffMs / 3600000);
            const minutes = Math.floor((diffMs % 3600000) / 60000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            }
            return `${minutes}min`;
        }
        
        // å…³é—­å‰§åœº
        function closeTheatre() {
            window.history.back();
        }
        
        // ç»§ç»­å¯¹è¯
        function continueConversation() {
            alert('ç»§ç»­å¯¹è¯åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // å¯¼å‡ºä¼šè¯
        function exportConversation() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // ç¼–è¾‘ä¿¡æ¯
        function editInfo() {
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // åˆ é™¤ä¼šè¯
        function deleteConversation() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿ')) {
                alert('åˆ é™¤åŠŸèƒ½å¼€å‘ä¸­...');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function getStatusText(status) {
            const texts = {
                'active': 'ğŸŸ¢ æ´»è·ƒ',
                'completed': 'ğŸŸ¡ å·²å®Œæˆ',
                'archived': 'ğŸ”µ å·²å½’æ¡£'
            };
            return texts[status] || status;
        }
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
</body>
</html>

